<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶ü‡¶æ‡¶≤‡¶ø ‡¶ì ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶™‡ßç‡¶∞‡ßã</title>
    <meta name="theme-color" content="#009688">
    
    <!-- Google API Scripts (Added async defer to prevent blocking) -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        :root {
            --primary: #009688;
            --secondary: #00796b;
            --bg: #f4f7f6;
            --white: #ffffff;
            --text: #2c3e50;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --border: #e0e0e0;
        }

        [data-theme="dark"] {
            --bg: #121212;
            --white: #1e1e1e;
            --text: #e0e0e0;
            --border: #333;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 70px; -webkit-tap-highlight-color: transparent; }

        /* HEADER */
        .header {
            background: var(--primary); color: white; padding: 15px;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .header h1 { font-size: 18px; font-weight: 600; }
        .account-select { display: flex; flex-direction: column; cursor: pointer; }
        .account-select small { font-size: 11px; opacity: 0.9; margin-top: 2px; }
        .back-btn { font-size: 22px; cursor: pointer; margin-right: 15px; display: none; }
        
        /* NAVIGATION */
        .navbar {
            position: fixed; bottom: 0; width: 100%; background: var(--white);
            display: flex; justify-content: space-around; padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 99; border-top: 1px solid var(--border);
        }
        .nav-item { text-align: center; font-size: 12px; cursor: pointer; color: #7f8c8d; flex: 1; transition: 0.2s; }
        .nav-item.active { color: var(--primary); font-weight: bold; transform: scale(1.05); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 2px; }

        /* CARDS & LAYOUT */
        .container { padding: 15px; display: none; animation: fadeIn 0.3s; padding-bottom: 80px; }
        .container.active { display: block; }
        
        .card {
            background: var(--white); padding: 15px; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); margin-bottom: 12px; border: 1px solid var(--border);
        }
        .dashboard-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .inventory-card { background: linear-gradient(135deg, #34495e, #2c3e50); color: white; }
        
        /* NEW COMPACT DASHBOARD STYLES */
        .compact-card {
            padding: 15px; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white;
            border: none;
            border-radius: 10px 10px 0 0;
            margin-bottom: 0;
        }
        .balance-row {
            display: flex; justify-content: space-between; align-items: flex-end;
            background: rgba(0,0,0,0.15); padding: 10px; border-radius: 8px; margin-top: 10px;
        }

        /* FILTER SECTION */
        .filter-section {
            background: var(--primary);
            color: white; padding: 10px; 
            margin: 0 -15px 10px -15px; 
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .filter-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 5px; justify-content: center; }
        .f-tab { 
            padding: 5px 12px; background: rgba(0,0,0,0.2); border-radius: 20px; 
            font-size: 12px; white-space: nowrap; cursor: pointer; transition: 0.2s; color: rgba(255,255,255,0.9);
        }
        .f-tab.active { background: white; color: var(--primary); font-weight: bold; }
        
        .date-nav { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 8px; font-size: 13px; }
        .nav-arrow { font-size: 18px; padding: 0 15px; cursor: pointer; user-select: none; }

        /* STATS GRIDS */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 10px; }
        .stat-box { background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px; text-align: center; backdrop-filter: blur(5px); }
        .stat-label { font-size: 11px; opacity: 0.9; display: block; margin-bottom: 4px; }
        .stat-val { font-size: 16px; font-weight: bold; }
        
        /* LISTS */
        .list-item {
            display: flex; flex-direction: column;
            padding: 12px 0; border-bottom: 1px solid var(--border); transition: 0.2s;
        }
        .list-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        .avatar {
            width: 45px; height: 45px; background: #eee; color: #555;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin-right: 12px; font-size: 18px;
        }
        .balance-pos { color: var(--danger); font-weight: bold; } 
        .balance-neg { color: var(--success); font-weight: bold; } 

        /* BUTTONS & INPUTS */
        button {
            background: var(--primary); color: white; border: none;
            padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px;
            width: 100%; transition: 0.2s; font-weight: 500;
        }
        button:active { transform: scale(0.97); opacity: 0.9; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { width: auto; padding: 5px 10px; font-size: 12px; }
        .btn-xs { padding: 3px 8px; font-size: 11px; border-radius: 4px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        
        input, select {
            width: 100%; padding: 12px; margin-bottom: 12px;
            border: 1px solid var(--border); border-radius: 8px;
            background: var(--white); color: var(--text); outline: none;
        }
        input:focus { border-color: var(--primary); }

        /* FLOATING ACTION BUTTON */
        .fab {
            position: fixed; bottom: 80px; right: 20px;
            background: var(--primary); color: white;
            width: 55px; height: 55px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer; z-index: 90; transition: 0.3s;
        }
        .fab:active { transform: rotate(45deg); }

        /* STICKY FOOTER ACTIONS */
        .action-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--white); padding: 10px 15px;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            display: none; gap: 10px; z-index: 200;
        }
        .action-footer.active { display: flex; }

        /* MODAL */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none;
            justify-content: center; align-items: flex-end; z-index: 300;
        }
        .modal-content {
            background: var(--white); width: 100%; max-width: 500px;
            padding: 25px; border-radius: 20px 20px 0 0;
            animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* RECEIPT STYLES */
        .receipt-box {
            background: #fff; padding: 20px; margin-bottom: 15px;
            border: 1px dashed #ccc; border-radius: 5px;
            text-align: center; position: relative; color: #333;
        }
        .receipt-header { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: var(--primary); }
        .receipt-meta { font-size: 12px; color: #777; margin-bottom: 15px; }
        .receipt-amount { font-size: 32px; font-weight: bold; margin: 10px 0; }
        .receipt-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .receipt-footer { font-size: 12px; margin-top: 15px; font-style: italic; opacity: 0.7; }

        /* UTILS */
        .text-muted { color: #888; font-size: 12px; }
        .d-flex { display: flex; align-items: center; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; background: #eee; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div class="d-flex">
            <span class="back-btn" id="back-btn" onclick="app.goBack()">‚¨Ö</span>
            <div class="account-select" onclick="account.openModal()">
                <h1 id="page-title">‡¶ü‡¶æ‡¶≤‡¶ø ‡¶ñ‡¶æ‡¶§‡¶æ</h1>
                <small id="active-acc-name">‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡ßß ‚ñº</small>
            </div>
        </div>
        <div class="d-flex" gap="10">
             <div id="drive-status" style="width:10px; height:10px; border-radius:50%; background:#ccc; margin-right:10px;" title="Sync Status"></div>
             <div id="header-action" style="font-size:22px; cursor:pointer;" onclick="app.openSettings()">‚ãÆ</div>
        </div>
    </div>

    <!-- 1. TALLY LIST VIEW -->
    <div id="view-tally" class="container active">
        <div class="card dashboard-card">
            <div class="stat-grid" style="margin-top:0;">
                <div><span class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶¨‡ßã (Due)</span><div style="font-size:18px; font-weight:bold;">‡ß≥ <span id="dash-total-pabo">0</span></div></div>
                <div><span class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶¶‡ßá‡¶¨‡ßã (Payable)</span><div style="font-size:18px; font-weight:bold;">‡ß≥ <span id="dash-total-debo">0</span></div></div>
            </div>
            <hr style="margin: 10px 0; opacity:0.2;">
            <div style="text-align:center;">
                <span class="stat-label">‡¶®‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</span>
                <h1 style="font-size: 26px;">‡ß≥ <span id="dash-net-amount">0</span></h1>
                <span id="dash-net-status" class="badge" style="background:rgba(255,255,255,0.2); color:white;">-</span>
            </div>
        </div>

        <div class="card" style="padding:10px;">
            <input type="text" id="search-customer" placeholder="üîç ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶´‡ßã‡¶®..." onkeyup="tally.renderList()" style="margin-bottom:5px;">
        </div>
        
        <div class="card" style="padding:0 15px;">
            <div id="customer-list"></div>
        </div>
        
        <div class="fab" onclick="customer.openModal()">+</div>
    </div>

    <!-- 2. INVENTORY VIEW -->
    <div id="view-inventory" class="container">
        <div class="card inventory-card">
            <h3>‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>
            <div class="stat-grid">
                <div class="stat-box"><span class="stat-label">‡¶∏‡ßç‡¶ü‡¶ï ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ</span><div class="stat-val">‡ß≥ <span id="inv-stock-val">0</span></div></div>
                <div class="stat-box"><span class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</span><div class="stat-val">‡ß≥ <span id="inv-total-sales">0</span></div></div>
                <div class="stat-box"><span class="stat-label">‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶≤‡¶æ‡¶≠</span><div class="stat-val">‡ß≥ <span id="inv-est-profit">0</span></div></div>
                <div class="stat-box"><span class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü</span><div class="stat-val"><span id="inv-item-count">0</span></div></div>
            </div>
        </div>
        
        <div class="d-flex card" style="padding:10px;">
            <input type="text" id="search-product" placeholder="üîç ‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." onkeyup="inventory.renderList()" style="margin-bottom:0;">
        </div>
        <button class="btn-outline" style="background:white; margin-bottom:10px;" onclick="tally.openSellModal(null)">üõí ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø (‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂)</button>

        <div id="product-list" style="padding-bottom: 60px;"></div>
        <div class="fab" onclick="inventory.openModal()">+</div>
    </div>

    <!-- 3. CUSTOMER DETAIL VIEW -->
    <div id="view-customer-detail" class="container">
        
        <!-- COMPACT DASHBOARD -->
        <div class="card compact-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 id="cd-name" style="font-size: 18px; margin:0;">Name</h2>
                    <p id="cd-phone" style="opacity:0.8; font-size:12px;">Phone</p>
                </div>
                <span id="cd-status" class="badge" style="background:white; color:var(--primary);">Status</span>
            </div>

            <!-- Stats Grid -->
            <div class="stat-grid" style="margin-top: 10px; gap: 8px;">
                <div class="stat-box" style="padding: 8px; background: rgba(255,255,255,0.1);">
                    <span class="stat-label" style="color: #ffcdd2;">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø (‡¶¶‡ßá‡¶Ø‡¶º‡¶æ)</span>
                    <div class="stat-val" style="font-size:14px;">‡ß≥ <span id="cd-total-given">0</span></div>
                </div>
                <div class="stat-box" style="padding: 8px; background: rgba(255,255,255,0.1);">
                    <span class="stat-label" style="color: #c8e6c9;">‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ (‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ)</span>
                    <div class="stat-val" style="font-size:14px;">‡ß≥ <span id="cd-total-received">0</span></div>
                </div>
            </div>

            <!-- Net Balance Row -->
            <div class="balance-row">
                <span style="font-size:13px;">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏:</span>
                <span style="font-size: 22px; font-weight:bold;">‡ß≥ <span id="cd-balance">0</span></span>
            </div>
        </div>
        
        <!-- FILTER BAR (Default: All) -->
        <div class="filter-section">
            <div class="filter-tabs">
                <div class="f-tab active" onclick="filter.set('all', this)">‡¶∏‡¶¨</div>
                <div class="f-tab" onclick="filter.set('daily', this)">‡¶¶‡ßà‡¶®‡¶ø‡¶ï</div>
                <div class="f-tab" onclick="filter.set('weekly', this)">‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï</div>
                <div class="f-tab" onclick="filter.set('monthly', this)">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï</div>
                <div class="f-tab" onclick="filter.set('yearly', this)">‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï</div>
            </div>
            <div class="date-nav" id="filter-nav-controls">
                <div class="nav-arrow" onclick="filter.move(-1)">‚ùÆ</div>
                <div id="filter-date-display" style="font-weight:bold;">All Time</div>
                <div class="nav-arrow" onclick="filter.move(1)">‚ùØ</div>
            </div>
        </div>

        <div id="customer-tx-list" class="card" style="padding:0 10px; background:transparent; border:none; box-shadow:none; margin-top:-10px;"></div>
    </div>

    <!-- 4. PRODUCT DETAIL VIEW -->
    <div id="view-product-detail" class="container">
        <div class="card inventory-card" style="text-align:center;">
            <h2 id="pd-name">Product Name</h2>
            <div class="stat-grid-3">
                <div class="stat-box"><span class="stat-label">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï</span><div class="stat-val"><span id="pd-stock">0</span></div></div>
                <div class="stat-box"><span class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</span><div class="stat-val"><span id="pd-sold">0</span></div></div>
                <div class="stat-box"><span class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü</span><div class="stat-val">‡ß≥<span id="pd-income">0</span></div></div>
            </div>
            <div class="stat-grid" style="margin-top:10px;">
                <div class="stat-box"><span class="stat-label">‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</span><div class="stat-val">‡ß≥<span id="pd-buy">0</span></div></div>
                <div class="stat-box"><span class="stat-label">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</span><div class="stat-val">‡ß≥<span id="pd-sell">0</span></div></div>
            </div>
        </div>

        <div class="card">
            <h4 style="margin-bottom:10px;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</h4>
            <div class="btn-group" style="margin-top:0;">
                <button class="btn-success" onclick="inventory.stockAction('in')">‚ûï ‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®</button>
                <button class="btn-danger" onclick="inventory.stockAction('out')">‚ûñ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶â‡¶ü</button>
            </div>
            <div class="btn-group">
                 <button class="btn-outline" onclick="inventory.editCurrent()">üìù ‡¶è‡¶°‡¶ø‡¶ü</button>
                 <button class="btn-outline" style="color:red; border-color:red;" onclick="inventory.deleteCurrent()">üóëÔ∏è ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
            </div>
        </div>
        
        <h4 style="margin:15px 5px; color:#666;">‡¶∏‡ßç‡¶ü‡¶ï ‡¶≤‡¶ó ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h4>
        <div id="product-history-list"></div>
    </div>

    <!-- 5. SETTINGS VIEW -->
    <div id="view-settings" class="container">
        <div class="card">
            <h3>Google Drive Backup</h3>
            <p class="text-muted" style="margin:10px 0;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá Google Drive ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
            <div id="drive-ui-area">
                <button id="btn-g-connect" onclick="gDrive.handleAuthClick()" style="background:#4285F4;">Connect Google Drive</button>
            </div>
            <div id="drive-actions" style="display:none; margin-top:10px;">
                <p style="color:green; font-weight:bold; margin-bottom:10px;">‚úÖ Connected</p>
                <button class="btn-outline" onclick="gDrive.restoreFromDrive()">‚òÅÔ∏è Restore from Drive</button>
                <button class="btn-danger" onclick="gDrive.signOut()" style="margin-top:10px;">Sign Out</button>
            </div>
        </div>

        <div class="card">
            <h3>‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
            <button class="btn-outline" onclick="dataManager.exportJSON()" style="margin-top:10px;">üì• ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
            <input type="file" id="import-file" style="margin-top:10px;" onchange="dataManager.importJSON(this)">
            <button class="btn-danger" onclick="app.resetAll()" style="margin-top:20px;">‚ö†Ô∏è ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- MAIN NAVBAR (Bottom) -->
    <div class="navbar" id="main-navbar">
        <div class="nav-item active" onclick="app.nav('tally')"><span class="nav-icon">üìí</span>‡¶ü‡¶æ‡¶≤‡¶ø</div>
        <div class="nav-item" onclick="app.nav('inventory')"><span class="nav-icon">üì¶</span>‡¶∏‡ßç‡¶ü‡¶ï</div>
        <div class="nav-item" onclick="app.nav('settings')"><span class="nav-icon">üõ†</span>‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</div>
    </div>

    <!-- STICKY ACTION FOOTER (For Customer Detail) -->
    <div class="action-footer" id="customer-footer">
        <button class="btn-success" onclick="tally.openTransModal('payment')">üì• ‡¶ú‡¶Æ‡¶æ ‡¶®‡¶ø‡¶®</button>
        <button class="btn-danger" onclick="tally.openTransModal('due')">üì§ ‡¶ñ‡¶∞‡¶ö/‡¶¨‡¶æ‡¶ï‡¶ø</button>
    </div>

    <!-- MODALS -->

    <!-- Account Manager Modal -->
    <div id="modal-accounts" class="modal">
        <div class="modal-content">
            <h3>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü / ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ</h3>
            <div id="account-list" style="margin:15px 0;"></div>
            <div class="d-flex" style="gap:5px;">
                <input type="text" id="new-acc-name" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ..." style="margin-bottom:0;">
                <button class="btn-sm" onclick="account.create()">+ Add</button>
            </div>
            <button class="btn-outline" onclick="app.closeModal('modal-accounts')" style="margin-top:15px;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
    
    <!-- Customer Add/Edit -->
    <div id="modal-customer" class="modal">
        <div class="modal-content">
            <h3>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h3>
            <input type="hidden" id="c-id">
            <input type="text" id="c-name" placeholder="‡¶®‡¶æ‡¶Æ *">
            <input type="text" id="c-phone" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤">
            <input type="text" id="c-address" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ">
            <div class="btn-group">
                <button class="btn-outline" onclick="app.closeModal('modal-customer')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button onclick="customer.save()">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Transaction Modal (Add/Edit) -->
    <div id="modal-trans" class="modal">
        <div class="modal-content">
            <h3 id="tx-title">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</h3>
            <input type="hidden" id="tx-id">
            <input type="hidden" id="tx-type">
            <input type="number" id="tx-amount" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ *" style="font-size:18px; font-weight:bold;">
            <input type="text" id="tx-note" placeholder="‡¶¨‡¶æ‡¶¨‡¶¶ / ‡¶®‡ßã‡¶ü">
            <input type="date" id="tx-date">
            <div class="btn-group">
                <button class="btn-outline" onclick="app.closeModal('modal-trans')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button onclick="tally.saveTransaction()">‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- RECEIPT MODAL -->
    <div id="modal-receipt" class="modal" style="align-items: center;">
        <div class="modal-content" style="border-radius: 10px; max-width: 360px;">
            <div id="receipt-capture-area" class="receipt-box">
                <h2 id="rec-shop-name" class="receipt-header">‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡ßß</h2>
                <p id="rec-date" class="receipt-meta">Date: --</p>
                <hr style="opacity:0.3; margin:10px 0;">
                
                <div style="text-align:left; margin-bottom:10px;">
                    <span style="font-size:12px; color:#555;">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞:</span><br>
                    <b id="rec-c-name" style="font-size:16px;">Customer Name</b>
                </div>

                <div style="background:#f9f9f9; padding:10px; border-radius:5px;">
                    <div id="rec-type" class="badge" style="display:inline-block; margin-bottom:5px;">TYPE</div>
                    <h1 id="rec-amount" class="receipt-amount">‡ß≥ 0</h1>
                    <p id="rec-note" style="font-size:13px; color:#555;">Note goes here</p>
                </div>

                <hr style="opacity:0.3; margin:15px 0;">
                
                <div class="receipt-row">
                    <span>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏:</span>
                    <b id="rec-balance">‡ß≥ 0</b>
                </div>
                
                <p class="receipt-footer">‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶ü‡¶æ‡¶≤‡¶ø ‡¶™‡ßç‡¶∞‡ßã ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ï‡ßÉ‡¶§</p>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-success" onclick="tally.shareReceiptNative()" style="flex:1;">üì§ ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ (‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø)</button>
                <button class="btn-success" style="background:#25D366; flex:1;" onclick="tally.shareReceiptWhatsApp()">üìû WhatsApp</button>
            </div>
            <button class="btn-outline" style="margin-top:10px; border:none; color:#777;" onclick="app.closeModal('modal-receipt')">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- Transaction Options Modal (Popup) -->
    <div id="modal-tx-options" class="modal" style="align-items: center;">
        <div class="modal-content" style="border-radius: 15px; margin: 20px; max-width: 400px;">
            <div style="text-align: center;">
                <h3 id="opt-tx-note" style="margin-bottom: 5px;">‡¶®‡ßã‡¶ü</h3>
                <p id="opt-tx-date" class="text-muted">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</p>
                <h1 id="opt-tx-amount" style="margin: 15px 0; font-size: 32px;">‡ß≥ 0</h1>
                <p id="opt-tx-type" class="badge">‡¶ü‡¶æ‡¶á‡¶™</p>
            </div>
            
            <hr style="margin: 20px 0; opacity: 0.2;">

            <div style="display: flex; gap: 10px;">
                <button class="btn-success" onclick="tally.shareFromModal()" style="display:flex; justify-content:center; align-items:center; gap:5px;">
                    üì± Text
                </button>
                <button class="btn-outline" onclick="tally.editFromModal()">
                    ‚úèÔ∏è Edit
                </button>
                <button class="btn-outline" style="border-color: var(--danger); color: var(--danger);" onclick="tally.deleteFromModal()">
                    üóëÔ∏è Delete
                </button>
            </div>

            <button class="btn-outline" style="margin-top: 15px; border:none; color: #777;" onclick="app.closeModal('modal-tx-options')">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- Product Add/Edit -->
    <div id="modal-product" class="modal">
        <div class="modal-content">
            <h3>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h3>
            <input type="hidden" id="p-id">
            <input type="text" id="p-name" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ *">
            <div class="stat-grid">
                <input type="number" id="p-buy" placeholder="‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø">
                <input type="number" id="p-sell" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø">
            </div>
            <div class="stat-grid">
                <input type="number" id="p-stock" placeholder="‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï">
                <input type="text" id="p-unit" placeholder="‡¶è‡¶ï‡¶ï (Pcs/Kg)">
            </div>
            <div class="btn-group">
                <button class="btn-outline" onclick="app.closeModal('modal-product')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button onclick="inventory.save()">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Sell Modal -->
    <div id="modal-sell" class="modal">
        <div class="modal-content">
            <h3>‡¶™‡¶£‡ßç‡¶Ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</h3>
            <label class="text-muted">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)</label>
            <select id="sell-c-select"></select>
            <label class="text-muted">‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</label>
            <select id="sell-p-select" onchange="tally.updateSellPrice()"></select>
            
            <div class="stat-grid">
                <div>
                    <label class="text-muted">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
                    <input type="number" id="sell-qty" value="1" oninput="tally.updateSellTotal()">
                </div>
                <div>
                    <label class="text-muted">‡¶¶‡¶∞</label>
                    <input type="number" id="sell-rate" oninput="tally.updateSellTotal()">
                </div>
            </div>
            
            <div style="text-align:right; font-size:18px; font-weight:bold; margin-bottom:15px; color:var(--primary);">
                ‡¶Æ‡ßã‡¶ü: ‡ß≥ <span id="sell-total">0</span>
            </div>
            
            <input type="text" id="sell-note" placeholder="‡¶®‡ßã‡¶ü (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)">
            <div class="btn-group">
                <button class="btn-outline" onclick="app.closeModal('modal-sell')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button onclick="tally.confirmSell()">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Stock In/Edit Modal -->
    <div id="modal-stock-in" class="modal">
        <div class="modal-content">
            <h3 id="sin-title">‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <p id="sin-p-name" style="margin-bottom:10px; font-weight:bold; color:var(--primary);"></p>
            <label class="text-muted">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
            <input type="number" id="sin-qty" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
            <label id="sin-cost-label" class="text-muted">‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</label>
            <input type="number" id="sin-cost" placeholder="‡¶¶‡¶∞">
            <div class="btn-group">
                <button class="btn-outline" onclick="app.closeModal('modal-stock-in')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button onclick="inventory.confirmStockIn()">‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

     <!-- Inventory Log Options Modal -->
    <div id="modal-log-options" class="modal" style="align-items: center;">
        <div class="modal-content" style="border-radius: 15px; margin: 20px; max-width: 400px; text-align: center;">
            <h3 id="opt-log-type" style="margin-bottom: 5px;">Type</h3>
            <p id="opt-log-date" class="text-muted">Date</p>
            <h1 style="margin: 15px 0; font-size: 32px;">
                <span id="opt-log-qty">0</span> <span id="opt-log-unit" style="font-size: 16px; color:#777;">unit</span>
            </h1>
            
            <hr style="margin: 20px 0; opacity: 0.2;">

            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn-outline" onclick="inventory.editFromModal()">
                    ‚úèÔ∏è Edit
                </button>
                <button class="btn-outline" style="border-color: var(--danger); color: var(--danger);" onclick="inventory.deleteFromModal()">
                    üóëÔ∏è Delete
                </button>
            </div>
            <button class="btn-outline" style="margin-top: 15px; border:none; color: #777;" onclick="app.closeModal('modal-log-options')">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- Customer Actions Modal (Edit/Delete) -->
    <div id="modal-c-actions" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h3>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
            <button class="btn-outline" onclick="customer.editCurrent()" style="margin-bottom:10px;">‚úèÔ∏è ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn-danger" onclick="customer.deleteCurrent()">üóëÔ∏è ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn-outline" style="margin-top:15px; border:none; color:#777;" onclick="app.closeModal('modal-c-actions')">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <script>
        // ========================
        // CONFIGURATION
        // ========================
        const CONFIG = {
            CLIENT_ID: "229880141922-3qbr26c4c4j3lboh6qaaonlo6rl5fci2.apps.googleusercontent.com",
            API_KEY: "YOUR_API_KEY_HERE", 
            DB_KEY: 'smart_tally_pro_v1' // Old key maintained to preserve data
        };

        // ========================
        // FILTER SYSTEM (DEFAULT: ALL)
        // ========================
        const filter = {
            type: 'all', // Changed default to 'all'
            date: new Date(),
            set: function(t, el) {
                this.type = t;
                document.querySelectorAll('.f-tab').forEach(x => x.classList.remove('active'));
                el.classList.add('active');
                this.updateUI();
                tally.viewCustomer(true);
            },
            move: function(dir) {
                const d = this.date;
                if(this.type === 'daily') d.setDate(d.getDate() + dir);
                else if(this.type === 'weekly') d.setDate(d.getDate() + (dir*7));
                else if(this.type === 'monthly') d.setMonth(d.getMonth() + dir);
                else if(this.type === 'yearly') d.setFullYear(d.getFullYear() + dir);
                this.date = new Date(d);
                this.updateUI();
                tally.viewCustomer(true);
            },
            updateUI: function() {
                const nav = document.getElementById('filter-nav-controls');
                const disp = document.getElementById('filter-date-display');
                const d = this.date;
                if(this.type === 'all') {
                    nav.style.display = 'none'; // Hide date nav for All
                } else {
                    nav.style.display = 'flex';
                    if(this.type === 'daily') disp.innerText = d.toLocaleDateString('bn-BD', {day:'numeric', month:'long', year:'numeric'});
                    else if(this.type === 'monthly') disp.innerText = d.toLocaleDateString('bn-BD', { month: 'long', year: 'numeric' });
                    else if(this.type === 'yearly') disp.innerText = d.toLocaleDateString('bn-BD', { year: 'numeric' });
                    else if(this.type === 'weekly') {
                        const start = new Date(d); start.setDate(d.getDate() - d.getDay());
                        const end = new Date(start); end.setDate(start.getDate() + 6);
                        disp.innerText = `${start.getDate()} - ${end.getDate()} ${start.toLocaleDateString('bn-BD', {month:'short'})}`;
                    }
                }
            },
            check: function(dateStr) {
                if(this.type === 'all') return true;
                const tx = new Date(dateStr); tx.setHours(0,0,0,0);
                const curr = new Date(this.date); curr.setHours(0,0,0,0);
                if(this.type === 'daily') return tx.getTime() === curr.getTime();
                if(this.type === 'monthly') return tx.getMonth() === curr.getMonth() && tx.getFullYear() === curr.getFullYear();
                if(this.type === 'yearly') return tx.getFullYear() === curr.getFullYear();
                if(this.type === 'weekly') {
                    const start = new Date(curr); start.setDate(curr.getDate() - curr.getDay());
                    const end = new Date(start); end.setDate(start.getDate() + 6);
                    return tx >= start && tx <= end;
                }
                return true;
            }
        };

        // ========================
        // DB & MULTI-ACCOUNT SYSTEM (FULL BACKUP SUPPORT)
        // ========================
        const db = {
            // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡ßá‡¶ü
            state: { 
                accounts: [], 
                activeId: null 
            },
            init: function() {
                const s = localStorage.getItem(CONFIG.DB_KEY);
                if(s) {
                    try { 
                        const parsed = JSON.parse(s);
                        
                        // ‡ßß. ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶è‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® (Multi-Account) ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶ø‡¶®‡¶æ
                        if(parsed.accounts && Array.isArray(parsed.accounts)) {
                            this.state = parsed;
                        } 
                        // ‡ß®. ‡¶Ø‡¶¶‡¶ø ‡¶™‡ßÅ‡¶∞‡¶®‡ßã (Single Account) ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶π‡ßü, ‡¶§‡¶¨‡ßá ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
                        else if(parsed.customers) {
                            this.state.accounts = [{
                                id: 'acc_def', 
                                name: '‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡ßß', 
                                data: {
                                    customers: parsed.customers || [],
                                    products: parsed.products || [], 
                                    inventoryLog: parsed.inventoryLog || []
                                }
                            }];
                            this.state.activeId = 'acc_def';
                            this.saveLocal(); // ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßá ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶≤‡ßã
                        }
                    } catch(e) { console.error("DB Load Error", e); }
                }
                
                // ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá (‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶ì‡¶™‡ßá‡¶®)
                if(this.state.accounts.length === 0) {
                    this.createAccount('‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®');
                }
                
                // ‡ß©. ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ (Sanity Check)
                this.state.accounts.forEach(acc => {
                    if(!acc.data) acc.data = {};
                    if(!acc.data.customers) acc.data.customers = [];
                    if(!acc.data.products) acc.data.products = []; // ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶Æ‡¶ø‡¶∏‡¶ø‡¶Ç ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶ï‡¶∞‡¶¨‡ßá
                    if(!acc.data.inventoryLog) acc.data.inventoryLog = [];
                });
            },
            createAccount: function(name) {
                const newAcc = { 
                    id: 'acc_' + Date.now(), 
                    name: name, 
                    data: { customers: [], products: [], inventoryLog: [] } 
                };
                this.state.accounts.push(newAcc);
                this.state.activeId = newAcc.id;
                this.saveLocal();
            },
            active: function() {
                // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡ßá
                return this.state.accounts.find(a => a.id === this.state.activeId) || this.state.accounts[0];
            },
            save: function() { 
                this.saveLocal(); 
                // gDrive.saveToDrive(this.state); // ‡¶Ø‡¶¶‡¶ø ‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶°‡ßç‡¶∞‡¶æ‡¶á‡¶≠ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶®
            },
            saveLocal: function() { 
                localStorage.setItem(CONFIG.DB_KEY, JSON.stringify(this.state)); 
            }
        };

        const account = {
            openModal: function() {
                const list = document.getElementById('account-list');
                const accounts = db.state.accounts;
                const activeId = db.state.activeId;
                list.innerHTML = accounts.map(a => `
                    <div class="list-item" style="flex-direction:row; justify-content:space-between; align-items:center;">
                        <div onclick="account.switch('${a.id}')" style="cursor:pointer; flex-grow:1;">
                            <b style="font-size:15px;">${a.name}</b>
                            ${a.id === activeId ? ' <span style="color:var(--success); font-size:12px;">(Active) ‚úÖ</span>' : ''}
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-xs" onclick="account.rename('${a.id}', '${a.name}')" style="border-color:#2196F3; color:#2196F3;">‚úèÔ∏è</button>
                            ${accounts.length > 1 && a.id !== activeId ? `<button class="btn-xs" style="border-color:red; color:red;" onclick="account.delete('${a.id}')">üóëÔ∏è</button>` : ''}
                        </div>
                    </div>
                `).join('');
                app.openModal('modal-accounts');
            },
            create: function() {
                const n = document.getElementById('new-acc-name').value;
                if(!n) return alert("‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®");
                db.createAccount(n);
                document.getElementById('new-acc-name').value = ''; 
                this.switch(db.state.activeId); // Switch to new immediately
            },
            
            // === [FIXED] SWITCH FUNCTION WITHOUT RELOAD ===
            switch: function(id) {
                if(db.state.activeId === id) return;
                
                // 1. Set Active ID
                db.state.activeId = id;
                db.saveLocal();
                
                // 2. Update Header Name
                const acc = db.active();
                document.getElementById('active-acc-name').innerText = acc.name + " ‚ñº";

                // 3. Reset Internal State (To avoid mixing data)
                app.currentCustomer = null;
                app.currentProduct = null;
                filter.type = 'all'; // Reset filter

                // 4. Force go to Main Tally List (To be safe)
                app.nav('tally');

                // 5. Close Modal
                app.closeModal('modal-accounts');
                
                // 6. Provide visual feedback (Optional)
                // alert(acc.name + " ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
            },

            rename: function(id, oldName) {
                const newName = prompt("‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®:", oldName);
                if (newName && newName.trim() !== "") {
                    const acc = db.state.accounts.find(a => a.id === id);
                    acc.name = newName.trim();
                    db.saveLocal();
                    if(db.state.activeId === id) document.getElementById('active-acc-name').innerText = newName + " ‚ñº";
                    this.openModal();
                }
            },
            delete: function(id) {
                if(!confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶è‡¶á ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶è‡¶¨‡¶Ç ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) return;
                db.state.accounts = db.state.accounts.filter(a => a.id !== id);
                db.saveLocal();
                this.openModal();
            }
        };

        // ========================
        // GOOGLE DRIVE
        // ========================
        const gDrive = {
            tokenClient: null, accessToken: null, fileId: null,
            init: function() {
                try {
                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CONFIG.CLIENT_ID, scope: 'https://www.googleapis.com/auth/drive.appdata',
                        callback: (resp) => {
                            if (resp.error) throw resp;
                            this.accessToken = resp.access_token;
                            localStorage.setItem('g_token', this.accessToken);
                            this.updateUI(true); this.findBackupFile();
                        },
                    });
                    if(localStorage.getItem('g_token')) { this.accessToken = localStorage.getItem('g_token'); this.updateUI(true); this.findBackupFile(); }
                } catch(e) {}
            },
            handleAuthClick: function() { this.tokenClient.requestAccessToken({prompt: ''}); },
            signOut: function() { this.accessToken = null; localStorage.removeItem('g_token'); this.updateUI(false); alert("Signed out"); },
            updateUI: function(connected) {
                const ui = document.getElementById('drive-ui-area'), actions = document.getElementById('drive-actions'), status = document.getElementById('drive-status');
                if(connected) { ui.style.display='none'; actions.style.display='block'; status.style.background='#2ecc71'; } 
                else { ui.style.display='block'; actions.style.display='none'; status.style.background='#ccc'; }
            },
            findBackupFile: async function() {
                if (!this.accessToken) return;
                try {
                    const res = await fetch("https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=name='smart_tally_backup.json'&fields=files(id, name)", { headers: { 'Authorization': `Bearer ${this.accessToken}` } });
                    const data = await res.json();
                    if (data.files && data.files.length > 0) this.fileId = data.files[0].id;
                } catch (e) {}
            },
            saveToDrive: async function(jsonData) {
                if (!this.accessToken) return;
                document.getElementById('drive-status').style.background = '#f1c40f'; 
                const blob = new Blob([JSON.stringify(jsonData)], { type: 'application/json' });
                const metadata = { name: 'smart_tally_backup.json', parents: ['appDataFolder'] };
                let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', method = 'POST';
                if (this.fileId) { url = `https://www.googleapis.com/upload/drive/v3/files/${this.fileId}?uploadType=media`; method = 'PATCH'; }
                const form = new FormData();
                if(!this.fileId) form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);
                try {
                    await fetch(url, { method: method, headers: { 'Authorization': `Bearer ${this.accessToken}` }, body: this.fileId ? blob : form });
                    setTimeout(() => document.getElementById('drive-status').style.background = '#2ecc71', 1000); 
                } catch (e) { document.getElementById('drive-status').style.background = 'red'; }
            },
            restoreFromDrive: async function() {
                if(!this.fileId) { await this.findBackupFile(); }
                if(!this.fileId) return alert("‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
                if(!confirm("‡¶°‡ßç‡¶∞‡¶æ‡¶á‡¶≠ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) return;
                try {
                    const res = await fetch(`https://www.googleapis.com/drive/v3/files/${this.fileId}?alt=media`, { headers: { 'Authorization': `Bearer ${this.accessToken}` } });
                    const data = await res.json();
                    db.state = data; db.saveLocal();
                    alert("‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); location.reload();
                } catch(e) { alert("Restore Failed"); }
            }
        };

        // ========================
        // CORE APP LOGIC
        // ========================
        const app = {
            currentCustomer: null, currentProduct: null,
            init: function() {
                db.init(); gDrive.init();
                document.getElementById('active-acc-name').innerText = db.active().name + " ‚ñº";
                filter.updateUI(); this.nav('tally');
            },
            nav: function(page) {
                document.querySelectorAll('.container').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                document.getElementById('back-btn').style.display = 'none';
                document.getElementById('main-navbar').style.display = 'flex';
                document.getElementById('customer-footer').classList.remove('active');
                document.getElementById('header-action').style.display = 'none';
                if(page === 'tally') {
                    document.getElementById('view-tally').classList.add('active');
                    document.querySelectorAll('.nav-item')[0].classList.add('active');
                    document.getElementById('page-title').innerText = "‡¶ü‡¶æ‡¶≤‡¶ø ‡¶ñ‡¶æ‡¶§‡¶æ";
                    tally.renderList();
                } else if(page === 'inventory') {
                    document.getElementById('view-inventory').classList.add('active');
                    document.querySelectorAll('.nav-item')[1].classList.add('active');
                    document.getElementById('page-title').innerText = "‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø";
                    inventory.renderList();
                } else if(page === 'settings') {
                    document.getElementById('view-settings').classList.add('active');
                    document.querySelectorAll('.nav-item')[2].classList.add('active');
                    document.getElementById('page-title').innerText = "‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏";
                }
            },
            goBack: function() {
                if(document.getElementById('view-customer-detail').classList.contains('active')) this.nav('tally');
                else if(document.getElementById('view-product-detail').classList.contains('active')) this.nav('inventory');
                else this.nav('tally');
            },
            openModal: (id) => document.getElementById(id).style.display = 'flex',
            closeModal: (id) => document.getElementById(id).style.display = 'none',
            openSettings: function() {
                if(document.getElementById('view-customer-detail').classList.contains('active')) this.openModal('modal-c-actions');
            },
            resetAll: function() {
                if(confirm("‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) { localStorage.removeItem(CONFIG.DB_KEY); location.reload(); }
            }
        };

        // ========================
        // TALLY LOGIC
        // ========================
        const tally = {
            currentTxId: null,
            renderList: function() {
                const data = db.active().data;
                const q = document.getElementById('search-customer').value.toLowerCase();
                const list = data.customers.filter(c => c.name.toLowerCase().includes(q));
                let pabo = 0, debo = 0;
                list.forEach(c => { if(c.balance > 0) pabo += c.balance; else debo += Math.abs(c.balance); });
                document.getElementById('dash-total-pabo').innerText = pabo.toLocaleString();
                document.getElementById('dash-total-debo').innerText = debo.toLocaleString();
                document.getElementById('dash-net-amount').innerText = Math.abs(pabo - debo).toLocaleString();
                const netStatus = document.getElementById('dash-net-status');
                if(pabo - debo >= 0) { netStatus.innerText = "‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡¶æ‡¶¨‡ßá‡¶®"; netStatus.style.background = "#e74c3c"; }
                else { netStatus.innerText = "‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá"; netStatus.style.background = "#2ecc71"; }
                document.getElementById('customer-list').innerHTML = list.map(c => `
                    <div class="list-item" onclick="app.currentCustomer='${c.id}'; tally.viewCustomer()">
                        <div class="list-row">
                            <div class="d-flex">
                                <div class="avatar">${c.name.charAt(0).toUpperCase()}</div>
                                <div><b style="font-size:15px;">${c.name}</b><br><span class="text-muted">${c.phone || ''}</span></div>
                            </div>
                            <span class="${c.balance >= 0 ? 'balance-pos' : 'balance-neg'}" style="font-size:16px;">${Math.abs(c.balance).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');
            },
            viewCustomer: function(keepView) {
                const data = db.active().data;
                const c = data.customers.find(x => x.id === app.currentCustomer);
                if(!c) return;
                if(!keepView) {
                    document.querySelectorAll('.container').forEach(e => e.classList.remove('active'));
                    document.getElementById('view-customer-detail').classList.add('active');
                    document.getElementById('back-btn').style.display = 'block';
                    document.getElementById('main-navbar').style.display = 'none';
                    document.getElementById('customer-footer').classList.add('active');
                    document.getElementById('header-action').style.display = 'block';
                    document.getElementById('page-title').innerText = "‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏";
                }
                
                const txs = (c.transactions || []).filter(t => filter.check(t.date));
                
                let totalGiven = 0, totalReceived = 0;
                txs.forEach(t => { 
                    if(t.type === 'due') totalGiven += t.amount; 
                    else totalReceived += t.amount; 
                });

                const periodBalance = totalGiven - totalReceived;

                document.getElementById('cd-name').innerText = c.name;
                document.getElementById('cd-phone').innerText = c.phone || "No Phone";
                document.getElementById('cd-total-given').innerText = totalGiven.toLocaleString();
                document.getElementById('cd-total-received').innerText = totalReceived.toLocaleString();
                document.getElementById('cd-balance').innerText = Math.abs(periodBalance).toLocaleString();
                
                const statusBadge = document.getElementById('cd-status');
                if(periodBalance > 0) { statusBadge.innerText = "‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡¶æ‡¶¨‡ßá‡¶®"; statusBadge.style.color = "#e74c3c"; }
                else if(periodBalance < 0) { statusBadge.innerText = "‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá"; statusBadge.style.color = "#2ecc71"; }
                else { statusBadge.innerText = "‡¶∏‡¶Æ‡¶æ‡¶®"; statusBadge.style.color = "#555"; }

                document.getElementById('customer-tx-list').innerHTML = txs.length ? txs.slice().reverse().map(t => `
                    <div class="list-item" onclick="tally.openOptions('${t.id}')" style="cursor:pointer;">
                        <div class="list-row">
                            <div><b>${t.note || '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®'}</b><br><span class="text-muted">${t.date}</span></div>
                            <div style="text-align:right;"><span style="color:${t.type === 'payment' ? 'green' : 'red'}; font-weight:bold;">${t.type === 'payment' ? '+' : '-'} ${t.amount}</span></div>
                        </div>
                    </div>
                `).join('') : '<div style="text-align:center; padding:20px; color:#aaa;">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á</div>';
            },
            openOptions: function(txId) {
                this.currentTxId = txId;
                const data = db.active().data;
                const c = data.customers.find(x => x.id === app.currentCustomer);
                const tx = c.transactions.find(t => t.id === txId);
                if(!tx) return;
                document.getElementById('opt-tx-note').innerText = tx.note || "‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®";
                document.getElementById('opt-tx-date').innerText = tx.date;
                document.getElementById('opt-tx-amount').innerText = "‡ß≥ " + tx.amount;
                document.getElementById('opt-tx-amount').style.color = tx.type === 'payment' ? 'green' : 'red';
                const typeBadge = document.getElementById('opt-tx-type');
                if(tx.type === 'payment') { typeBadge.innerText = "‡¶ú‡¶Æ‡¶æ (Cash In)"; typeBadge.style.background = "#dcedc8"; typeBadge.style.color = "green"; } 
                else { typeBadge.innerText = "‡¶ñ‡¶∞‡¶ö/‡¶¨‡¶æ‡¶ï‡¶ø (Due)"; typeBadge.style.background = "#ffcdd2"; typeBadge.style.color = "red"; }
                app.openModal('modal-tx-options');
            },
            shareFromModal: function() {
                const data = db.active().data;
                const c = data.customers.find(x => x.id === app.currentCustomer);
                const tx = c.transactions.find(t => t.id === this.currentTxId);
                this.shareTx(c.name, tx.amount, tx.type, tx.date, c.balance);
            },
            editFromModal: function() { app.closeModal('modal-tx-options'); this.editTx(this.currentTxId); },
            deleteFromModal: function() { app.closeModal('modal-tx-options'); this.deleteTx(this.currentTxId); },

            openTransModal: function(type) {
                document.getElementById('tx-id').value = '';
                document.getElementById('tx-type').value = type;
                document.getElementById('tx-amount').value = '';
                document.getElementById('tx-note').value = '';
                document.getElementById('tx-date').valueAsDate = new Date();
                const title = type === 'payment' ? '‡¶ú‡¶Æ‡¶æ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (Cash In)' : '‡¶ñ‡¶∞‡¶ö / ‡¶¨‡¶æ‡¶ï‡¶ø (Due)';
                document.getElementById('tx-title').innerText = title;
                document.getElementById('tx-title').style.color = type === 'payment' ? 'green' : 'red';
                app.openModal('modal-trans');
            },
            saveTransaction: function() {
                const amt = parseFloat(document.getElementById('tx-amount').value);
                if(!amt) return alert("‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®");
                const type = document.getElementById('tx-type').value;
                const note = document.getElementById('tx-note').value;
                const date = document.getElementById('tx-date').value;
                const txId = document.getElementById('tx-id').value;
                const data = db.active().data;
                const c = data.customers.find(x => x.id === app.currentCustomer);
                
                let isNew = false;
                
                if(txId) {
                    const idx = c.transactions.findIndex(t => t.id === txId);
                    if(idx > -1) {
                        const oldTx = c.transactions[idx];
                        if(oldTx.type === 'due') c.balance -= oldTx.amount; else c.balance += oldTx.amount;
                        c.transactions[idx] = { ...oldTx, amount: amt, note: note, date: date, type: type };
                        if(type === 'due') c.balance += amt; else c.balance -= amt;
                    }
                } else {
                    isNew = true;
                    if(!c.transactions) c.transactions = [];
                    const newTx = { id: 'tx_' + Date.now(), type: type, amount: amt, note: note, date: date };
                    c.transactions.push(newTx);
                    if(type === 'due') c.balance += amt; else c.balance -= amt;
                }
                
                db.save(); 
                app.closeModal('modal-trans'); 
                this.viewCustomer(true);

                // SHOW RECEIPT IF NEW TRANSACTION
                if (isNew) {
                    this.showReceipt(c, amt, type, note, date);
                }
            },
            // === NEW: Show Receipt Popup ===
            showReceipt: function(customer, amount, type, note, date) {
                const shop = db.active().name;
                document.getElementById('rec-shop-name').innerText = shop;
                document.getElementById('rec-date').innerText = "Date: " + date;
                document.getElementById('rec-c-name').innerText = customer.name;
                document.getElementById('rec-amount').innerText = "‡ß≥ " + amount;
                document.getElementById('rec-amount').style.color = type === 'payment' ? 'green' : 'red';
                document.getElementById('rec-note').innerText = note || (type === 'payment' ? '‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ú‡¶Æ‡¶æ' : '‡¶¨‡¶æ‡¶ï‡¶ø');
                
                const tBadge = document.getElementById('rec-type');
                if(type==='payment') { tBadge.innerText="‡¶ú‡¶Æ‡¶æ (Received)"; tBadge.style.background="#dcedc8"; tBadge.style.color="green"; }
                else { tBadge.innerText="‡¶¨‡¶æ‡¶ï‡¶ø (Due)"; tBadge.style.background="#ffcdd2"; tBadge.style.color="red"; }

                const balTxt = customer.balance > 0 ? `‡ß≥ ${customer.balance} (‡¶™‡¶æ‡¶¨‡ßã)` : (customer.balance < 0 ? `‡ß≥ ${Math.abs(customer.balance)} (‡¶¶‡ßá‡¶¨‡ßã)` : `‡ß≥ 0`);
                document.getElementById('rec-balance').innerText = balTxt;

                app.openModal('modal-receipt');
            },
            
            // === HELPER: Get Message String ===
            getReceiptMsg: function() {
                const shop = document.getElementById('rec-shop-name').innerText;
                const date = document.getElementById('rec-date').innerText;
                const cName = document.getElementById('rec-c-name').innerText;
                const amount = document.getElementById('rec-amount').innerText;
                const type = document.getElementById('rec-type').innerText;
                const note = document.getElementById('rec-note').innerText;
                const balance = document.getElementById('rec-balance').innerText;

                return `*${shop}*\n---------------------\n${date}\n‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞: ${cName}\n‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®: ${type}\n‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ${amount}\n‡¶¨‡¶ø‡¶¨‡¶∞‡¶£: ${note}\n---------------------\n${balance}\n---------------------\n‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§`;
            },

            // === OPTION 1: NATIVE SHARE (Other Apps) ===
            shareReceiptNative: function() {
                const msg = this.getReceiptMsg();
                if (navigator.share) {
                    navigator.share({
                        title: '‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∞‡¶ø‡¶∏‡¶ø‡¶ü',
                        text: msg
                    }).catch(console.error);
                } else {
                    navigator.clipboard.writeText(msg).then(() => alert("‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶û‡ßç‡¶ú‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§"));
                }
            },

            // === OPTION 2: DIRECT WHATSAPP ===
            shareReceiptWhatsApp: function() {
                const msg = this.getReceiptMsg();
                window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
            },

            editTx: function(id) {
                const data = db.active().data;
                const c = data.customers.find(x => x.id === app.currentCustomer);
                const tx = c.transactions.find(t => t.id === id);
                document.getElementById('tx-id').value = tx.id;
                document.getElementById('tx-type').value = tx.type;
                document.getElementById('tx-amount').value = tx.amount;
                document.getElementById('tx-note').value = tx.note;
                document.getElementById('tx-date').value = tx.date;
                document.getElementById('tx-title').innerText = "‡¶è‡¶°‡¶ø‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®";
                app.openModal('modal-trans');
            },
            deleteTx: function(id) {
                if(!confirm("‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) return;
                const data = db.active().data;
                const c = data.customers.find(x => x.id === app.currentCustomer);
                const tx = c.transactions.find(t => t.id === id);
                if(tx.type === 'due') c.balance -= tx.amount; else c.balance += tx.amount;
                c.transactions = c.transactions.filter(t => t.id !== id);
                db.save(); this.viewCustomer(true);
            },
            shareTx: function(name, amount, type, date, bal) {
                const shop = db.active().name;
                const typeTxt = type === 'payment' ? '‡¶ú‡¶Æ‡¶æ' : '‡¶¨‡¶æ‡¶ï‡¶ø';
                const balTxt = parseFloat(bal) > 0 ? `${bal} (‡¶™‡¶æ‡¶¨‡ßã)` : `${Math.abs(bal)} (‡¶¶‡ßá‡¶¨‡ßã)`;
                const msg = `*${shop}*\n---------------------\n‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${date}\n‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞: ${name}\n‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®: ${typeTxt}\n‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ‡ß≥${amount}\n---------------------\n*‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ‡ß≥${balTxt}*\n---------------------\n‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§`;
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            },
            openSellModal: function(cid) {
                const data = db.active().data;
                if(data.products.length === 0) return alert("‡¶Ü‡¶ó‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®");
                
                document.getElementById('sell-note').value = '';

                const cSelect = document.getElementById('sell-c-select');
                cSelect.innerHTML = `<option value="">-- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ --</option>` + data.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                if(cid) cSelect.value = cid;
                const pSelect = document.getElementById('sell-p-select');
                pSelect.innerHTML = data.products.map(p => `<option value="${p.id}" data-rate="${p.sell}">${p.name} (‡¶Æ‡¶ú‡ßÅ‡¶¶: ${p.stock})</option>`).join('');
                this.updateSellPrice(); app.openModal('modal-sell');
            },
            updateSellPrice: function() {
                const sel = document.getElementById('sell-p-select');
                if(sel.selectedIndex > -1) { document.getElementById('sell-rate').value = sel.options[sel.selectedIndex].getAttribute('data-rate'); this.updateSellTotal(); }
            },
            updateSellTotal: function() {
                const q = parseFloat(document.getElementById('sell-qty').value) || 0;
                const r = parseFloat(document.getElementById('sell-rate').value) || 0;
                document.getElementById('sell-total').innerText = (q * r).toFixed(0);
            },
            confirmSell: function() {
                const data = db.active().data;
                const pid = document.getElementById('sell-p-select').value;
                const cid = document.getElementById('sell-c-select').value;
                const qty = parseFloat(document.getElementById('sell-qty').value);
                const rate = parseFloat(document.getElementById('sell-rate').value);
                const note = document.getElementById('sell-note').value;

                if(!pid || !qty) return alert("‡¶™‡¶£‡ßç‡¶Ø ‡¶è‡¶¨‡¶Ç ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®");

                const product = data.products.find(p => p.id === pid);
                if(product.stock < qty) return alert("‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§!");

                product.stock -= qty;

                data.inventoryLog.push({ 
                    id: 'log_' + Date.now(), 
                    productId: pid, 
                    type: 'out', 
                    qty: qty, 
                    rate: rate,
                    note: note,
                    date: new Date().toISOString().split('T')[0] 
                });

                if(cid) {
                    const cust = data.customers.find(c => c.id === cid);
                    if(cust) {
                        if(!cust.transactions) cust.transactions = [];
                        const total = qty * rate;
                        cust.transactions.push({ 
                            id: 'tx_' + Date.now(), 
                            type: 'due', 
                            amount: total, 
                            note: `‡¶™‡¶£‡ßç‡¶Ø: ${product.name} x ${qty} ${note ? '('+note+')' : ''}`, 
                            date: new Date().toISOString().split('T')[0] 
                        });
                        cust.balance += total;
                    }
                }

                db.save(); 
                app.closeModal('modal-sell');

                inventory.renderList(); 
                if(document.getElementById('view-product-detail').classList.contains('active')) {
                    if(app.currentProduct === pid) inventory.viewDetail();
                }
                if(app.currentCustomer && cid === app.currentCustomer && document.getElementById('view-customer-detail').classList.contains('active')) {
                    this.viewCustomer(true);
                }
            }
        };

        const customer = {
            openModal: function() {
                document.getElementById('c-id').value = ''; document.getElementById('c-name').value = '';
                document.getElementById('c-phone').value = ''; document.getElementById('c-address').value = ''; app.openModal('modal-customer');
            },
            editCurrent: function() {
                const data = db.active().data; const c = data.customers.find(x => x.id === app.currentCustomer);
                app.closeModal('modal-c-actions');
                document.getElementById('c-id').value = c.id; document.getElementById('c-name').value = c.name;
                document.getElementById('c-phone').value = c.phone; document.getElementById('c-address').value = c.address; app.openModal('modal-customer');
            },
            save: function() {
                const data = db.active().data;
                const id = document.getElementById('c-id').value; const name = document.getElementById('c-name').value;
                const phone = document.getElementById('c-phone').value; const address = document.getElementById('c-address').value;
                if(!name) return alert("‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá");
                if(id) {
                    const c = data.customers.find(x => x.id === id); c.name = name; c.phone = phone; c.address = address;
                    if(app.currentCustomer === id) { document.getElementById('cd-name').innerText = name; document.getElementById('cd-phone').innerText = phone; }
                } else {
                    data.customers.push({ id: 'c_' + Date.now(), name: name, phone: phone, address: address, balance: 0, transactions: [] });
                }
                db.save(); app.closeModal('modal-customer'); tally.renderList();
            },
            deleteCurrent: function() {
                if(!confirm("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) return;
                const data = db.active().data; data.customers = data.customers.filter(c => c.id !== app.currentCustomer);
                db.save(); app.closeModal('modal-c-actions'); app.nav('tally');
            }
        };

        const inventory = {
            currentLogId: null,
            isEditingLog: false,
            logTypeEditing: null, // 'in' or 'out'

            renderList: function() {
                const data = db.active().data;
                const q = document.getElementById('search-product').value.toLowerCase();
                const list = data.products.filter(p => p.name.toLowerCase().includes(q));
                
                let totalStockVal = 0;
                let totalSold = 0;

                list.forEach(p => {
                    totalStockVal += (p.stock * p.buy);
                    const logs = data.inventoryLog.filter(l => l.productId === p.id && l.type === 'out');
                    totalSold += logs.reduce((sum, l) => sum + (l.qty * l.rate), 0);
                });

                document.getElementById('inv-stock-val').innerText = totalStockVal.toLocaleString();
                document.getElementById('inv-total-sales').innerText = totalSold.toLocaleString();
                document.getElementById('inv-est-profit').innerText = "---"; 
                document.getElementById('inv-item-count').innerText = list.length;

                document.getElementById('product-list').innerHTML = list.map(p => `
                    <div class="list-item" onclick="app.currentProduct='${p.id}'; inventory.viewDetail()">
                        <div class="list-row">
                            <div>
                                <b>${p.name}</b>
                                <br><small class="text-muted">Buy: ${p.buy} | Sell: ${p.sell}</small>
                            </div>
                            <div style="text-align:right;">
                                <span class="badge" style="background:var(--secondary); color:white; font-size:13px;">${p.stock} ${p.unit}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            save: function() {
                const data = db.active().data;
                const id = document.getElementById('p-id').value;
                const name = document.getElementById('p-name').value;
                if(!name) return alert("‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï");

                const product = {
                    id: id || 'p_' + Date.now(),
                    name: name,
                    buy: parseFloat(document.getElementById('p-buy').value) || 0,
                    sell: parseFloat(document.getElementById('p-sell').value) || 0,
                    stock: parseFloat(document.getElementById('p-stock').value) || 0,
                    unit: document.getElementById('p-unit').value || 'Pcs'
                };

                if(id) {
                    const idx = data.products.findIndex(p => p.id === id);
                    const oldStock = data.products[idx].stock; 
                    const manualStock = document.getElementById('p-stock').value;
                    if(manualStock !== "" && !isNaN(manualStock)) product.stock = parseFloat(manualStock);
                    else product.stock = oldStock;

                    data.products[idx] = product;
                    
                    if(app.currentProduct === id) {
                        db.save();
                        app.closeModal('modal-product');
                        this.viewDetail(); 
                        return;
                    }
                } else {
                    product.stock = parseFloat(document.getElementById('p-stock').value) || 0;
                    data.products.push(product);
                    if(product.stock > 0) {
                        data.inventoryLog.push({
                            id: 'l_'+Date.now(), productId: product.id, type: 'in', qty: product.stock, date: new Date().toISOString().split('T')[0]
                        });
                    }
                }
                
                db.save();
                app.closeModal('modal-product');
                this.renderList();
            },

            viewDetail: function() {
                const data = db.active().data;
                const p = data.products.find(x => x.id === app.currentProduct);
                if(!p) return;

                document.querySelectorAll('.container').forEach(e => e.classList.remove('active'));
                document.getElementById('view-product-detail').classList.add('active');
                document.getElementById('back-btn').style.display = 'block';
                document.getElementById('main-navbar').style.display = 'none';

                const logs = data.inventoryLog.filter(l => l.productId === p.id);
                const soldLogs = logs.filter(l => l.type === 'out');
                
                const soldQty = soldLogs.reduce((sum, l) => sum + l.qty, 0);
                const income = soldLogs.reduce((sum, l) => sum + (l.qty * l.rate), 0);

                document.getElementById('pd-name').innerText = p.name;
                document.getElementById('pd-stock').innerText = p.stock + " " + p.unit;
                document.getElementById('pd-sold').innerText = soldQty;
                document.getElementById('pd-income').innerText = "‡ß≥ " + income.toLocaleString();
                document.getElementById('pd-buy').innerText = p.buy;
                document.getElementById('pd-sell').innerText = p.sell;

                document.getElementById('product-history-list').innerHTML = logs.slice().reverse().map(l => `
                    <div class="list-item" onclick="inventory.openLogOptions('${l.id}')" style="cursor:pointer; border-left: 4px solid ${l.type==='in'?'#2ecc71':'#e74c3c'}; padding-left:10px;">
                        <div class="list-row">
                            <div>
                                <b>${l.type === 'in' ? '‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®' : '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü'}</b>
                                <br><small>${l.date}</small>
                                ${l.note ? `<br><small class="text-muted" style="font-style:italic;">"${l.note}"</small>` : ''}
                            </div>
                            <div style="text-align:right;">
                                <b>${l.qty}</b>
                                ${l.type==='out' ? `<br><small>@ ${l.rate} tk</small>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            openLogOptions: function(logId) {
                this.currentLogId = logId;
                const data = db.active().data;
                const log = data.inventoryLog.find(l => l.id === logId);
                const p = data.products.find(x => x.id === app.currentProduct);
                
                if(!log) return;

                document.getElementById('opt-log-type').innerText = log.type === 'in' ? '‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶® (Stock In)' : '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü (Sale)';
                document.getElementById('opt-log-type').style.color = log.type === 'in' ? 'green' : 'red';
                document.getElementById('opt-log-date').innerText = log.date;
                document.getElementById('opt-log-qty').innerText = log.qty;
                document.getElementById('opt-log-unit').innerText = p.unit;
                
                app.openModal('modal-log-options');
            },

            // === UPDATED: Edit Both In and Out ===
            editFromModal: function() {
                const data = db.active().data;
                const log = data.inventoryLog.find(l => l.id === this.currentLogId);
                const p = data.products.find(x => x.id === app.currentProduct);
                app.closeModal('modal-log-options');

                this.isEditingLog = true;
                this.logTypeEditing = log.type;

                document.getElementById('sin-title').innerText = log.type === 'in' ? "‡¶è‡¶°‡¶ø‡¶ü: ‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®" : "‡¶è‡¶°‡¶ø‡¶ü: ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü";
                document.getElementById('sin-p-name').innerText = p.name;
                document.getElementById('sin-qty').value = log.qty;
                
                if (log.type === 'in') {
                    document.getElementById('sin-cost-label').innerText = "‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø";
                    document.getElementById('sin-cost').value = p.buy; // Default to current buy price
                } else {
                    document.getElementById('sin-cost-label').innerText = "‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¶‡¶∞ (Rate)";
                    document.getElementById('sin-cost').value = log.rate; 
                }

                app.openModal('modal-stock-in');
            },

            deleteFromModal: function() {
                app.closeModal('modal-log-options');
                this.deleteLog(this.currentLogId);
            },
            
            deleteLog: function(id) {
                if(!confirm("‡¶è‡¶á ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ú‡¶æ‡¶∏‡ßç‡¶ü ‡¶π‡¶¨‡ßá‡•§ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) return;
                
                const data = db.active().data;
                const p = data.products.find(x => x.id === app.currentProduct);
                const log = data.inventoryLog.find(l => l.id === id);
                
                if(log) {
                    if(log.type === 'in') p.stock -= log.qty;
                    else p.stock += log.qty; // Sale deleted, stock returns
                    
                    data.inventoryLog = data.inventoryLog.filter(l => l.id !== id);
                    db.save();
                    
                    this.viewDetail(); 
                    this.renderList();
                }
            },

            stockAction: function(type) {
                this.isEditingLog = false;
                if(type === 'out') {
                    tally.openSellModal(null);
                    setTimeout(() => {
                        const sel = document.getElementById('sell-p-select');
                        sel.value = app.currentProduct;
                        tally.updateSellPrice();
                    }, 100);
                } else {
                    const data = db.active().data;
                    const p = data.products.find(x => x.id === app.currentProduct);
                    
                    this.logTypeEditing = 'in';
                    document.getElementById('sin-title').innerText = "‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®";
                    document.getElementById('sin-p-name').innerText = p.name;
                    document.getElementById('sin-qty').value = '';
                    document.getElementById('sin-cost-label').innerText = "‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø";
                    document.getElementById('sin-cost').value = p.buy;
                    app.openModal('modal-stock-in');
                }
            },

            // === UPDATED: Confirm Stock (Handles Edits for Both In and Out) ===
            confirmStockIn: function() {
                const qty = parseFloat(document.getElementById('sin-qty').value);
                const costOrRate = parseFloat(document.getElementById('sin-cost').value);
                
                if(!qty) return alert("‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶ï‡¶∞‡ßÅ‡¶®");

                const data = db.active().data;
                const p = data.products.find(x => x.id === app.currentProduct);

                if(this.isEditingLog && this.currentLogId) {
                    const log = data.inventoryLog.find(l => l.id === this.currentLogId);
                    if(log) {
                        if (log.type === 'in') {
                            // Revert old add, apply new
                            p.stock -= log.qty;
                            p.stock += qty;
                            if(costOrRate) p.buy = costOrRate; // Update buy price
                        } else {
                            // Revert old sale (add back), apply new sale (subtract)
                            p.stock += log.qty;
                            p.stock -= qty;
                            log.rate = costOrRate; // Update sell rate
                        }
                        log.qty = qty;
                    }
                } else {
                    // New Stock In
                    p.stock += qty;
                    data.inventoryLog.push({
                        id: 'l_'+Date.now(), 
                        productId: p.id, 
                        type: 'in', 
                        qty: qty, 
                        date: new Date().toISOString().split('T')[0]
                    });
                    if(costOrRate) p.buy = costOrRate;
                }

                db.save();
                app.closeModal('modal-stock-in');
                this.isEditingLog = false;
                this.logTypeEditing = null;
                
                this.viewDetail();
                this.renderList();
            },
            
            openModal: function() {
                ['p-id','p-name','p-buy','p-sell','p-stock','p-unit'].forEach(i => document.getElementById(i).value = '');
                app.openModal('modal-product');
            },

            editCurrent: function() {
                const data = db.active().data;
                const p = data.products.find(x => x.id === app.currentProduct);
                document.getElementById('p-id').value = p.id;
                document.getElementById('p-name').value = p.name;
                document.getElementById('p-buy').value = p.buy;
                document.getElementById('p-sell').value = p.sell;
                document.getElementById('p-stock').value = p.stock;
                document.getElementById('p-unit').value = p.unit;
                app.openModal('modal-product');
            },

            deleteCurrent: function() {
                if(!confirm("‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) return;
                const data = db.active().data;
                data.products = data.products.filter(p => p.id !== app.currentProduct);
                db.save();
                app.nav('inventory');
            }
        };

        // ========================
        // DATA MANAGER (FIXED BACKUP BUTTON)
        // ========================
        const dataManager = {
            exportJSON: function() {
                try {
                    // ‡ßß. ‡¶™‡ßÅ‡¶∞‡ßã ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ (‡¶∏‡¶¨ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ì ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø) ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç ‡¶è ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞
                    const fullData = JSON.stringify(db.state);
                    
                    // ‡ß®. ‡¶è‡¶®‡¶ï‡ßã‡¶°‡ßá‡¶° ‡¶á‡¶â‡¶Ü‡¶∞‡¶è‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø (Data URI Scheme)
                    // ‡¶è‡¶ü‡¶ø Java Code ‡¶è‡¶∞ 'else' ‡¶¨‡ßç‡¶≤‡¶ï‡ßá ‡¶ß‡¶∞‡¶æ ‡¶™‡ßú‡¶¨‡ßá
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(fullData);
                    
                    // ‡ß©. ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø: ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶¶‡ßÉ‡¶∂‡ßç‡¶Ø ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ
                    // ‡¶è‡¶ü‡¶ø WebView ‡¶è‡¶∞ DownloadListener ‡¶ï‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "backup.json");
                    document.body.appendChild(downloadAnchorNode); // ‡¶¨‡¶°‡¶ø‡¶§‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ
                    downloadAnchorNode.click(); // ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ
                    downloadAnchorNode.remove(); // ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ
                    
                } catch (e) {
                    alert("‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + e.message);
                    console.error(e);
                }
            },
            
            importJSON: function(input) {
                if (!input.files || !input.files[0]) return;
                
                const fr = new FileReader();
                fr.onload = e => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ß‡¶∞‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
                        let newDataState = null;

                        // ‡¶ü‡¶æ‡¶á‡¶™ ‡ßß: ‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø-‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü (‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü)
                        if(importedData.accounts && Array.isArray(importedData.accounts)) {
                            newDataState = importedData;
                        } 
                        // ‡¶ü‡¶æ‡¶á‡¶™ ‡ß®: ‡¶ì‡¶≤‡ßç‡¶° ‡¶∏‡¶ø‡¶ô‡ßç‡¶ó‡ßá‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü
                        else if(importedData.customers) {
                            newDataState = { 
                                accounts: [{
                                    id: 'acc_restored_' + Date.now(), 
                                    name: 'Restored Shop', 
                                    data: {
                                        customers: importedData.customers || [],
                                        products: importedData.products || [], 
                                        inventoryLog: importedData.inventoryLog || []
                                    }
                                }], 
                                activeId: null 
                            };
                            newDataState.activeId = newDataState.accounts[0].id;
                        }

                        if(newDataState) {
                            if(confirm("‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶π‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
                                db.state = newDataState;
                                // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶ü‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® (‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßá ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ)
                                db.state.accounts.forEach(acc => {
                                    if(!acc.data) acc.data = {};
                                    if(!acc.data.customers) acc.data.customers = [];
                                    if(!acc.data.products) acc.data.products = [];
                                    if(!acc.data.inventoryLog) acc.data.inventoryLog = [];
                                });

                                db.saveLocal(); 
                                alert("‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); 
                                location.reload(); 
                            }
                        } else {
                            alert("‡¶≠‡ßÅ‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü!");
                        }
                    } catch(e) { 
                        alert("‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶™‡ßú‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§"); 
                    }
                };
                fr.readAsText(input.files[0]);
                input.value = ''; // ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
            }
        };

        window.onload = app.init.bind(app);
    </script>
</body>
</html>